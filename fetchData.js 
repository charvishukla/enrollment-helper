/**
 * File: fetchData.js
 * Date: 08/20/2022
 * Author: Charvi Shukla
 * Converts data stored in the form of HTML into a JS object, and subsequently 
 * into a JSON object 
 */
const {
    table
} = require("console");
const fs = require("fs");
const jsdom = require("jsdom");
const {
    JSDOM
} = jsdom;

const PATH_TO_CATALOG_HTML = "alltables.html";

/**
 * This function reads a given HTML document and creates a DOM for it. Since the 
 * HTML document only contains tables, we call the result "tables."
 * @returns an array of HTML tables.
 */
function getTablesFromFile() {
    const data = fs.readFileSync(PATH_TO_CATALOG_HTML, {
        encoding: "utf-8"
    });
    const dom = new JSDOM(data);
    const tables = dom.window.document.getElementsByTagName("table");
    return tables;
}

/**
 * fetches the tables from the HTML file and converst HTML data to the JSON format.
 */
function main() {
    let tables = getTablesFromFile();
    let json = tablesToSubjects(tables);
    fs.writeFileSync("catalog.json", JSON.stringify(json));
}

/**
 * @param tables of course data. Tables is an array of multiple HTML tables. This 
 * method traverses through each table and extracts the HTML data contained within 
 * each table. 
 * The extracted data is pushed into an array and that array is then used to 
 * populate a JavaScript object.
 * @returns JavaScript object for each subject [i.e. the ENTIRE catalog].
 */
function tablesToSubjects(tables) {
    let subjectArr = [];
    for (let i = 0; i < tables.length; i++) {
        let subjectJSON = buildIndividualSubjectJSON(tables.item(i));
        subjectArr.push(subjectJSON);
    }
    return {
        subject: subjectArr,
    };
}


/**
 * @param table is a single table from an array of HTML tables.
 * @returns a javascript object containing course data from a SINGLE table.
 * The object contains all the courses offered in one subject/department.
 */
function buildIndividualSubjectJSON(table) {
    // gets the list of all subjects aka departments 
    let subjectName = table.querySelector("span.centeralign").innerHTML.trim();

    return {
        subject: subjectName,
        classInfo: tabletoCourses(table),
        discussionInfo: getDiscussionData(table)
    }
}


function tabletoCourses(table) {
    let courseName = [];
    let courseNumber = [];
    let numUnits = [];
    let prof = [];

    let tr = Array.from(table.querySelectorAll("tr:not([class])"));
    for (let i = 4; i < tr.length; i++) {
        let cols = Array.from(tr[i].querySelectorAll("td.crsheader"));
        courseNumber.push(cols[1].innerHTML);
        courseName.push(cols[2].querySelector("span.boldtxt").innerHTML.trim());
        numUnits.push(cols[2].querySelector("text"));
    }
    console.log(courseNumber);
    console.log(courseName);
    console.log(numUnits);
    // gets a list of courses whithin a subject 
    // let getcourseList = table.querySelectorAll("span.boldtxt");
    // let subjectCourseList = [];
    // for (let i = 0; i < getcourseList.length; i++) {
    //     if (isCourseName(getcourseList[i].innerHTML.trim())) {
    //         subjectCourseList.push(getcourseList[i].innerHTML.trim());
    //     }
    // }
    // var jsonArr = [];
    // for (let i = 0; i < subjectCourseList.length; i++) {
    //     jsonArr.push({
    //         courseName: subjectCourseList[i]
    //     })
    // }
    // return jsonArr
}

function removeAllChildNodes(parent) {
    while (parent.firstChild) {
        parent.removeChild(parent.firstChild);
    }
}

tb = getTablesFromFile();
randomtb = tb[0];
randomtb2 = tb[1];
randomtb3 = tb[2];
randomtb4 = tb[3];
randomtb5 = tb[4];
randomtb6 = tb[5];
randomtb7 = tb[6];
randomtb8 = tb[7];
randomtb9 = tb[8];
randomtb10 = tb[9];

tabletoCourses(randomtb)


/**
 * 
 * @param table 
 * @returns 
 */
function getDiscussionData(table) {
    // arrays to categorize different kinds of data 
    let secID = [];
    let secTiming = [];
    let secDays = [];
    let secBuilding = [];
    let secRoom = [];

    let data = table.querySelectorAll("tr.sectxt"); // selecting a row
    let arr = Array.from(data); // nodelist --> array
    for (let i = 0; i < arr.length; i++) {
        // columns from each row are saved in an array.
        let columns = Array.from(arr[i].querySelectorAll("td.brdr")); 
        // predicate to find if the row contains discussion information.
        let isDI = columns[3].innerHTML; 
        if (isDI === '<span id="insTyp" title="Discussion">DI</span>') {
            // cancelled Discussions have less than 13 columns.
            if(columns.length !== 13){
                secID.push("course cancelled");
                secDays.push("course cancelled");
                secTiming.push("course cancelled");
                secBuilding.push("course cancelled");
                secRoom.push("course cancelled");
            } else {
                secID.push(columns[4].innerHTML);
                secDays.push(columns[5].innerHTML.trim());
                secTiming.push(columns[6].innerHTML);
                secBuilding.push(columns[7].innerHTML.trim());
                secRoom.push(columns[8].innerHTML);
            }
        }
    }
    var jsonArr = [];
    for (let i = 0; i < secID.length; i++) {
        // storing all json objects in an array. 
        jsonArr.push({
            discussionSection: secID[i],
            discussionTiming: secTiming[i],
            discussionDays: secDays[i],
            discussionBuilding: secBuilding[i],
            discussionRoom: secRoom[i]
        })
    }
    return jsonArr;
}

// - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

// HELPER METHOD 1
function isCourseName(str) {
    if (str === "Prerequisites  " || str === "Resources" ||
        str === '<span title="CAPE - Course and Professor Evaluations">Evaluations</span>' ||
        str === "Prerequisites") {
        return false;
    } else {
        return true;
    }
}


// main();


